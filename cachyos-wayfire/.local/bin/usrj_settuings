#!/bin/bash
# //////////////////[ EDIT THESE ]//////////////////

MENUENTRIES=(\
"AUDIO" \
"BLUETOOTH" \
"NETWORK" \
"SCREENSHOT PROGRAM" \
"EDIT: COMPOSITOR CONFIG" \
"EDIT: TASKBAR CONFIG" \
"EDIT: TASKBAR STYLE" \
"EDIT: ENV VARIABLES" \
"EDIT: ALIASES" \
"EDIT: MIMEAPPS LISTS" \
"EDIT: THIS" \
)

COMMANDS=(\
"pipemixer" \
"bluetui" \
"nmtui" \
"setsid flameshot config & sleep 0.001" \
"nano ~/.config/wayfire/wayfire.ini" \
"nano ~/.config/waybar/config.jsonc" \
"nano ~/.config/waybar/style.css" \
"nano ~/.bash_profile" \
"nano ~/.bash_aliases" \
"nano ~/.local/share/applications/mimeinfo.cache ~/.config/mimeapps.list" \
"nano ~/.local/bin/usrj_settuings" \
)

# ///////////////////////////////////////////////////

# Great ressource:
# https://github.com/dylanaraps/writing-a-tui-in-bash

menuIdx=0
selected=0
moved=0

longestEntryCharCount=0
for i in ${!MENUENTRIES[@]}; do
  [ ${#MENUENTRIES[i]} -gt $longestEntryCharCount ] && longestEntryCharCount=${#MENUENTRIES[i]}
done

redraw() {
  #                                             (+ 2 = "> " next to the selection)
  widthPos=$(((charWidth - longestEntryCharCount + 2) / 2))

  # Move cursor to middle
  printf "[%u;%uH" $((($charHeight - ${#MENUENTRIES[@]}) / 2)) $widthPos

  for i in ${!MENUENTRIES[@]}; do
    if [ $i -eq $menuIdx ]; then
      printf "> [7m%s[0m" "${MENUENTRIES[i]}"
    else
      printf "  ${MENUENTRIES[i]}"
    fi

   # Align to widthPos & move cursor down a line
    printf "[%uG[B" $widthPos
  done
}

onResize() {
  read -r charHeight charWidth < <(stty size)
  printf "[2J"
  redraw
}

# Handle window resize event
trap 'onResize' WINCH

# Save (and clear) the user's terminal screen, hide the cursor and disable line wrapping
printf '[?1049h[?25l[?7l'

sleep 0.01 # Wait for the window to be properly sized first
onResize

while [ $selected -eq 0 ]; do
  # https://stackoverflow.com/a/61483332
  read -rsn1 userInput # get 1 character
  [ "$userInput" == "" ] && read -rsn4 -t 0.001 userInput # read 2 more chars

  case $userInput in
    # q, delete or shift+delete
    'q' | '[3~' | '[3$')
      break
      ;;

    # up or left, with/without shift
    '[A' | '[a' | '[D' | '[d')
      ((menuIdx-=1))
      [ $menuIdx -lt 0 ] && menuIdx=$((${#MENUENTRIES[@]} - 1))
      moved=1
      ;;

    # down or right, with/without shift
    '[B' | '[b' | '[C' | '[c')
      ((menuIdx+=1))
      [ $menuIdx -ge ${#MENUENTRIES[@]} ] && menuIdx=0
      moved=1
      ;;

    # enter, space and unfortunately escape...
    '')
      selected=1
      ;;
  esac

  [ $moved -eq 1 ] && redraw && moved=0
  [ $selected -eq 1 ] && eval "${COMMANDS[$menuIdx]}" && break
done

# Restore the user's terminal screen, show cursor and reenable line wrapping
printf '[?1049l[?25h[?7h'
